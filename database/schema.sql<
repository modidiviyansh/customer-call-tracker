-- Luxury Call Tracker Schema
-- Comprehensive design for call disposition tracking with agent PIN-based access

-- AGENT TABLE (Optional - for PIN tracking and agent management)
CREATE TABLE fcm_agent (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  pin_code TEXT NOT NULL UNIQUE,
  name TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- CUSTOMER TABLE
CREATE TABLE fcm_customer (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

-- CUSTOMER CONTACT TABLE
CREATE TABLE fcm_customer_contact (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  customer_id UUID REFERENCES fcm_customer(id) ON DELETE CASCADE,
  mobile TEXT NOT NULL,
  address_details TEXT, -- Flexible JSON or TEXT for storing address
  created_at TIMESTAMP DEFAULT NOW()
);

-- Index for fast lookup by mobile number
CREATE INDEX idx_fcm_customer_contact_mobile ON fcm_customer_contact(mobile);

-- CALL RECORDS TABLE (Core - disposition and history tracking)
CREATE TABLE fcm_customer_call_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  customer_id UUID REFERENCES fcm_customer(id) ON DELETE CASCADE,
  agent_pin TEXT NOT NULL, -- Store agent's entered PIN for tracking
  call_date TIMESTAMP DEFAULT NOW(), -- When call was made
  call_update TIMESTAMP, -- When record was updated/marked
  next_reminder_date DATE, -- Next follow-up/reminder
  remarks TEXT, -- Free-form notes
  call_status TEXT CHECK (
    call_status IN ('completed', 'no_answer', 'busy', 'follow_up', 'invalid', 'not_interested')
  ), -- Disposition marker
  call_duration INTEGER, -- seconds (optional)
  outcome_score INTEGER, -- e.g. 0-10 for agent rating (optional)
  created_at TIMESTAMP DEFAULT NOW()
);

-- Indexes for performance optimization
CREATE INDEX idx_fcm_call_reminder ON fcm_customer_call_records(next_reminder_date);
CREATE INDEX idx_fcm_call_agent_pin ON fcm_customer_call_records(agent_pin);
CREATE INDEX idx_fcm_call_date ON fcm_customer_call_records(call_date);
CREATE INDEX idx_fcm_call_status ON fcm_customer_call_records(call_status);

-- Additional indexes for dashboard queries
CREATE INDEX idx_fcm_call_today ON fcm_customer_call_records(call_date, agent_pin) 
  WHERE call_date >= CURRENT_DATE;

CREATE INDEX idx_fcm_call_reminders_today ON fcm_customer_call_records(next_reminder_date, agent_pin) 
  WHERE next_reminder_date = CURRENT_DATE;

-- Insert some sample agents (including the PIN 2342 from our system)
INSERT INTO fcm_agent (pin_code, name) VALUES 
  ('2342', 'Premium Agent'),
  ('1234', 'Support Agent'),
  ('5678', 'Sales Agent');

-- Insert sample customers
INSERT INTO fcm_customer (name) VALUES 
  ('John Smith'),
  ('Sarah Johnson'),
  ('Mike Wilson'),
  ('Emily Davis'),
  ('Robert Brown');

-- Insert sample customer contacts
INSERT INTO fcm_customer_contact (customer_id, mobile, address_details) 
SELECT 
  c.id,
  '+1' || (1000000000 + ROW_NUMBER() OVER())::TEXT,
  '{"street": "123 Main St", "city": "New York", "state": "NY", "zipCode": "10001"}'
FROM fcm_customer c;

-- Insert sample call records
INSERT INTO fcm_customer_call_records (customer_id, agent_pin, call_date, next_reminder_date, remarks, call_status)
SELECT 
  c.id,
  '2342',
  NOW() - INTERVAL '2 hours',
  CURRENT_DATE,
  'Customer interested in premium package. Follow up required.',
  'follow_up'
FROM fcm_customer c
LIMIT 1;

INSERT INTO fcm_customer_call_records (customer_id, agent_pin, call_date, next_reminder_date, remarks, call_status)
SELECT 
  c.id,
  '2342',
  NOW() - INTERVAL '1 day',
  CURRENT_DATE + INTERVAL '1 day',
  'Scheduled product demo for next week.',
  'completed'
FROM fcm_customer c
LIMIT 1;